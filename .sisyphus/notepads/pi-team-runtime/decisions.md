# Decisions

## [2026-02-11] Task 1: Architectural Decisions from DRAFT/Plan

- **Single Writer Pattern**: Confirmed. `teamd` will manage all state mutations to avoid file corruption.
- **File Formats**: JSON for state files, JSONL for append-only logs/threads.
- **IPC**: HTTP over localhost (127.0.0.1) with Bearer token authentication.
- **Lease Mechanism**: Epoch-based fencing is required to ensure only the current lease holder can commit results.
- **Extension Guard**: The extension MUST intercept `bash` and file write tools to enforce lease-based access control.

## 2026-02-11: Protocol & API Contract Decisions (MVP)

- **Auth Mechanism**: Use `Bearer` token for API authentication. The token is randomly generated by `teamd` on startup and stored in `runtime.json`.
- **Idempotency**: Mutating endpoints (`createTask`, `startThread`, `postThreadMessage`) MUST support the `Idempotency-Key` header. This is critical to prevent duplicate objects when LLMs or clients retry requests.
- **Schema Versioning**: Every JSON file (`team.json`, `task.json`, `runtime.json`) includes a `schemaVersion` field at the root.
- **Discovery**: `teamd` writes a `runtime.json` file with 0600 permissions in the team directory. This file contains the `url`, `token`, and `pid`, allowing agents to discover the daemon.
- **Permission Check Endpoint**: Added `GET /v1/can-write?path=...&agentId=...` to the API. This allows the `team-coordination` extension to check if an agent holds a valid lease for a task that covers the target path before allowing `write`/`edit`/`bash` operations.
- **Fencing with Epochs**: Every task has an `epoch` that increments on each claim. Mutating the task state (complete/fail) requires providing the `epoch` to ensure the agent still holds the valid lease.
- **Single-Writer Enforcement**: Confirmed that only `teamd` writes to the workspace. Extensions and CLI are strictly API clients for state mutations.
